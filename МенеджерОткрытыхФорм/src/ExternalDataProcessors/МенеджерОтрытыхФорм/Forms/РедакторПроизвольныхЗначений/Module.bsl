//Начальная версия
//При передаче динамического списка запускать расширенный редактор его настроек 

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	
	ВспомогательныеДанныеИнструмента	= Новый Структура;
	ВспомогательныеДанныеИнструмента.Вставить("ПроизвольныеЗначения", Новый Структура);
	
	
	ПроизвольныеЗначения	= Параметры.ПроизвольныеЗначения;
	
	
	Для Каждого КлючИЗначение Из ПроизвольныеЗначения Цикл
		
		ТекущееИмя			= КлючИЗначение.Ключ;
		ТекущееЗначение		= КлючИЗначение.Значение;
		ТипЗначения			= ТипЗнч(ТекущееЗначение);
		
		//ДобавляемыеРеквизиты	= Новый Массив;
		
		Если ТипЗначения = Тип("ДанныеФормыКоллекция") ИЛИ ТипЗначения = Тип("ДанныеФормыДерево") Тогда
			
			ДанныеЗначения	= ТекущееЗначение.Выгрузить(Новый Массив);
			
			ДобавитьРеквизитНаФорму(ЭтаФорма, ТекущееИмя, НовыйОписаниеТипов(ТипЗнч(ДанныеЗначения)));
			
			Для Каждого ТекущаяКолонка Из ДанныеЗначения.Колонки Цикл
				//Попытка
					ДобавитьРеквизитНаФорму(ЭтаФорма, ТекущаяКолонка.Имя, ТекущаяКолонка.ТипЗначения, ТекущееИмя, ТекущаяКолонка.Заголовок);
				//Исключение
				//КонецПопытки;
			КонецЦикла;
			
			//ЭтаФорма.ИзменитьРеквизиты(ДобавляемыеРеквизиты);
			КопироватьДанныеФормы(ТекущееЗначение,ЭтаФорма[ТекущееИмя]);
			
		ИначеЕсли ТипЗначения = Тип("Структура") ИЛИ ТипЗначения = Тип("Соответствие") Тогда
			
			ДобавитьРеквизитНаФорму(ЭтаФорма, ТекущееИмя, НовыйОписаниеТипов(Тип("ДеревоЗначений")));
			ДобавитьРеквизитНаФорму(ЭтаФорма, "Ключ", Новый ОписаниеТипов, ТекущееИмя);
			ДобавитьРеквизитНаФорму(ЭтаФорма, "ЭтоСтруктура", Новый ОписаниеТипов("Булево"), ТекущееИмя);
			ДобавитьРеквизитНаФорму(ЭтаФорма, "ЭтоСоответствие", Новый ОписаниеТипов("Булево"), ТекущееИмя);
			ДобавитьРеквизитНаФорму(ЭтаФорма, "Значение", Новый ОписаниеТипов, ТекущееИмя);
			
			ЗаполнитьДеревоИзСтруктурыСоответствия(ТекущееЗначение, ЭтаФорма[ТекущееИмя]);
			
		Иначе
			
			ДобавитьРеквизитНаФорму(ЭтаФорма, ТекущееИмя, НовыйОписаниеТипов(ТипЗнч(ДанныеЗначения)));
			ЗаполнитьЗначенияСвойств(Элементы.Найти(ТекущееИмя), Новый Структура(
			"ПоложениеЗаголовка						, АвтоМаксимальнаяШирина	, МногострочныйРежим", 
			ПоложениеЗаголовкаЭлементаФормы.Нет		, Ложь						, Истина));
			
			ЭтаФорма[ТекущееИмя]	= ТекущееЗначение;
			
		КонецЕсли;
		
		ВспомогательныеДанныеИнструмента.ПроизвольныеЗначения.Вставить(ТекущееИмя);

	КонецЦикла;
	
	
	
		
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Команда_Применить(Команда)
	
	ЗаполнитьЗначенияСвойств(ВспомогательныеДанныеИнструмента.ПроизвольныеЗначения, ЭтаФорма);
	ЭтаФорма.Закрыть(ВспомогательныеДанныеИнструмента.ПроизвольныеЗначения);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьДеревоИзСтруктурыСоответствия(ТекущееЗначение, ТекущийРодитель)
	
	Если ЭтоСтруктура(ТекущееЗначение) Тогда
		ЭтоСтруктура = Истина;
	ИначеЕсли ЭтоСоответствие(ТекущееЗначение) Тогда
		ЭтоСоответствие = Истина;
	Иначе
		Возврат;
	КонецЕсли;
	
	КоллекцияСтрок = ТекущийРодитель.ПолучитьЭлементы();
	Для Каждого КлючИЗначение Из ТекущееЗначение Цикл
		
		ОписаниеСтроки = КоллекцияСтрок.Добавить();
		ОписаниеСтроки.Ключ = КлючИЗначение.Ключ;
		
		НуждоПробежать = Истина;
		Если ЭтоСтруктура(КлючИЗначение.Значение) Тогда
			ОписаниеСтроки.ЭтоСтруктура = Истина;
		ИначеЕсли ЭтоСоответствие(КлючИЗначение.Значение) Тогда
			ОписаниеСтроки.ЭтоСоответствие = Истина;
		Иначе
			НуждоПробежать = Ложь;
		КонецЕсли;
		
		Если НуждоПробежать Тогда
			ЗаполнитьДеревоИзСтруктурыСоответствия(КлючИЗначение.Значение, ОписаниеСтроки);
		Иначе
			ОписаниеСтроки.Значение = КлючИЗначение.Значение;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ЭтоСтруктура(Значение) Экспорт
	
	ТипТекЗнч = ТипЗнч(Значение);
	Возврат ТипТекЗнч = Тип("Структура") ИЛИ ТипТекЗнч = Тип("ФиксированнаяСтруктура");
	
КонецФункции

&НаСервереБезКонтекста
Функция ЭтоСоответствие(Значение) Экспорт
	
	ТипТекЗнч = ТипЗнч(Значение);
	Возврат ТипТекЗнч = Тип("Соответствие") ИЛИ ТипТекЗнч = Тип("ФиксированноеСоответствие");
	
КонецФункции

&НаСервереБезКонтекста
Процедура ДобавитьРеквизитНаФорму(ЭтаФорма, Имя, ТипЗначения, Путь = "", Заголовок = Неопределено)
	
	ДобавитьРеквизитФормы(ЭтаФорма, Имя, ТипЗначения, Путь, Заголовок);
	
	
	ОписаниеЭлемента	= Новый Структура(
	"Видимость	, Доступность	, ТолькоПросмотр	, Вид						, ПутьКДанным",
	Истина		, Истина		, Ложь				, ВидПоляФормы.ПолеФлажка	, "");
	
	Если ТипЗначения.СодержитТип(Тип("ТаблицаЗначений")) Тогда
		ТипЭлемента	= Тип("ТаблицаФормы");
	Иначе
		ТипЭлемента	= Тип("ПолеФормы");
		Если ТипЗначения.СодержитТип(Тип("Булево")) И ТипЗначения.Типы().Количество() = 1 Тогда
			ОписаниеЭлемента.Вид	= ВидПоляФормы.ПолеФлажка;
		Иначе
			ОписаниеЭлемента.Вид	= ВидПоляФормы.ПолеВвода;
		КонецЕсли;
	КонецЕсли;
	
	ОписаниеЭлемента.ПутьКДанным	= ?(ПустаяСтрока(Путь), "", Путь + ".") + Имя;
	
	НовыйЭлемент	= ЭтаФорма.Элементы.Добавить(Имя, ТипЭлемента, ЭтаФорма.Элементы.Найти(Путь));
	ЗаполнитьЗначенияСвойств(НовыйЭлемент, ОписаниеЭлемента);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ДобавитьРеквизитФормы(ЭтаФорма, Имя, ТипЗначения, Путь = "", Заголовок = Неопределено)
	
	НовыйРеквизитФормы	= Новый РеквизитФормы(Имя, ТипЗначения, Путь, Заголовок, Ложь);
	
	ЭтаФорма.ИзменитьРеквизиты(ЗначениеВМассиве(НовыйРеквизитФормы));
	
	Возврат НовыйРеквизитФормы;

КонецФункции

&НаКлиентеНаСервереБезКонтекста
// Создает массив и помещает в него переданное значение.
//
// Параметры:
//  Значение - Произвольный - любое значение.
//
// Возвращаемое значение:
//  Массив - массив из одного элемента.
//
Функция ЗначениеВМассиве(Значение) Экспорт
	
	Массив = Новый Массив;
	Массив.Добавить(Значение);
	
	Возврат Массив;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
// Преобразует к описанию типов
//
// Параметры:
//  ПараметрТип  - ОписаниеТипов, Строка, Тип, Массив, СписокЗначений, Структура     - тип или коллекция типо для преобразование в ОписаниеТипов
//  ВПопытке     - булево                                                             - если Истина, тогда преобразование проискодит в попытке (мало ли) и при ошибке возвращает пустое описание типов
//
// Возвращаемое значение:
//   ОписаниеТипов   - результат преобразования
//
Функция НовыйОписаниеТипов(ПараметрТип, ВПопытке = Истина) Экспорт
	
	Если ВПопытке Тогда
		
		Попытка
			ОписаниеТипов = НовыйОписаниеТипов(ПараметрТип, Ложь);
		Исключение
			ОписаниеТипов = Новый ОписаниеТипов();
		КонецПопытки;
		
	Иначе
		
		ОписаниеТипов = Новый ОписаниеТипов();
		
		ТипПараметра = ТипЗнч(ПараметрТип);
		
		Если ПараметрТип = Неопределено Тогда
			//Пустое описание
		ИначеЕсли ТипПараметра = Тип("ОписаниеТипов") Тогда
			ОписаниеТипов = ПараметрТип;
		ИначеЕсли ТипПараметра = Тип("Строка") Тогда
			ОписаниеТипов = Новый ОписаниеТипов(ПараметрТип);
		ИначеЕсли ТипПараметра = Тип("Тип") Тогда
			ОписаниеТипов = Новый ОписаниеТипов(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ПараметрТип));
		ИначеЕсли ТипПараметра = Тип("Массив") Тогда
			Для Каждого Тип Из ПараметрТип Цикл
				ОписаниеТипов = Новый ОписаниеТипов(ОписаниеТипов, НовыйОписаниеТипов(Тип).Типы());
			КонецЦикла;
		ИначеЕсли ТипПараметра = Тип("СписокЗначений") ИЛИ ТипПараметра = Тип("Структура") Тогда
			Для Каждого Тип Из ПараметрТип Цикл
				ОписаниеТипов = Новый ОписаниеТипов(ОписаниеТипов, НовыйОписаниеТипов(Тип.Значение).Типы());
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ОписаниеТипов;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ОписаниеЗначенияПоУмолчанию(ЭтаФорма)
	
	ОписаниеЗначенияПоУмолчанию	= ШаблонОписанияЗначения();
	ЗаполнитьЗначенияСвойств(ОписаниеЗначенияПоУмолчанию, ЭтаФорма.ПараметрыРаботыИнструмента.ОбщиеПараметры);
	
	Возврат ОписаниеЗначенияПоУмолчанию;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ШаблонОписанияЗначения()
	
	ОписаниеЗначения	= Новый Структура;
	ОписаниеЗначения.Вставить("Ключ"			, Новый УникальныйИдентификатор);
	ОписаниеЗначения.Вставить("Значение"		, Неопределено);
	ОписаниеЗначения.Вставить("ТипЗначения"		, Новый ОписаниеТипов);
	ОписаниеЗначения.Вставить("ТолькоПросмотр"	, Ложь);
	ОписаниеЗначения.Вставить("ВыбиратьТип"		, Истина);
	
	Возврат ОписаниеЗначения;
	
КонецФункции

#КонецОбласти
